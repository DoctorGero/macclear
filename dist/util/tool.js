/**
 * MacClear 1.0.0
 * 帮助Mac 用户完全删除 App ,清理历史残留文件,提交 bug :154624410
 * Author lihaibo123as@163.com
 * Licensed under ISC
 * Released on: December 21, 2018
 */
var t=require("fs"),e=require("path");nw.loadCss=function(t,e){var i=document.getElementsByTagName("head")[0];if(t.content){var n=document.createElement("style");n.type="text/css",n.styleSheet?n.styleSheet.cssText=t.content:n.innerHTML=t.content,i.appendChild(n),e&&e()}else if(t.url){var s=document.createElement("link");s.href=t.url,s.rel="stylesheet",s.type="text/css",i.appendChild(s)}},Date.prototype.format=function(t){var e={"Y+":this.getFullYear(),"m+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"i+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var i in e)["m+","d+","H+","i+","s+"].includes(i)&&(e[i]=e[i]<10?"0"+e[i]:e[i]);for(var n in e)new RegExp("("+n+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[n]:("00"+e[n]).substr((""+e[n]).length)));return t};var i={demo:()=>new Promise((t,e)=>{try{t()}catch(t){e(t)}}),parsePlist:function(e){var{exec:i}=require("child_process");return new Promise((n,s)=>{try{t.exists(e,t=>{t?i(`/usr/libexec/PlistBuddy -c "Print" "${e}"`,(t,e,i)=>{if(t)s(t);else{var a=e.match(/(\S+)\s\=\s(.*)/g),o={};a&&a.forEach(t=>{var e=t.split(" = ");o[e[0]]||(o[e[0]]=e[1])}),n(o)}}):s(`文件不存在:${e}`)})}catch(t){s(t)}})},parseIcns:function(t){return new Promise((e,i)=>{try{require("iconutil").toIconset(t,function(n,s){if(n)return console.warn(`parseIcns出错: ${n},${t}`),void i(n);var a;if(s["icon_128x128.png"]?a=s["icon_128x128.png"]:s["icon_256x256.png"]?a=s["icon_256x256.png"]:s["icon_512x512.png"]&&(a=s["icon_512x512.png"]),a){var o="data:image/png;base64,"+a.toString("base64");e(o)}else console.warn("图标不存在",s),i("图标不存在")})}catch(t){i(t)}})},fileSize:function(e){var{exec:i}=require("child_process");return new Promise((n,s)=>{try{t.stat(e,function(t,a){if(t)return console.error(`stat出错: ${t}`),void s(t);if(a.isDirectory()||a.isFile()){var o=`du -h -d 0 "${e}"`;i(o,(t,e,i)=>{if(t)console.error(`exec:${o}出错:${t}`);else{var s=e.trim().split(/\s+/);n(s[0])}})}else s(`目录异常:${e}}`)})}catch(t){s(t)}})},searchDirs:function(i){var n=e.resolve(i),s=t.readdirSync(n),a=[];for(var o in s){var r=s[o];if(!/^\.(\S+)?$/.test(r)&&!/^.*\.app$/.test(r)){var c=e.join(n,r),p=t.statSync(c);p.isFile();p.isDirectory()&&a.push(c)}}return a},searchApp:function(i){return new Promise((n,s)=>{try{var a=e.resolve(i);t.readdir(a,function(i,o){if(i)s(i);else{var r=[];for(var c in o){var p=o[c];if(!/^\.(\S+)?$/.test(p)&&/^.*\.app$/.test(p)){var u=e.join(a,p),l=t.statSync(u),f=p.replace(".app",""),v=`${u}/Contents/Info.plist`;r.push({name:f,plistpath:v,filename:p,filepath:u,atimeMs:l.atimeMs,birthtimeMs:l.birthtimeMs,mtimeMs:l.mtimeMs,state:l})}}n(r)}})}catch(t){s(t)}})},appInfo:function(t){return async function(t){var e={plist:await i.parsePlist(t.plistpath),size:await i.fileSize(t.filepath)};try{if(e.plist.CFBundleIconFile){var n=e.plist.CFBundleIconFile.replace(".icns","");e.icon=await i.parseIcns(`${t.filepath}/Contents/Resources/${n}.icns`)}}catch(e){console.log("图标异常:",t.name)}return t.info=Object.assign({},e,t.info),t}(t)},searchDirFiles:function(i,n,s){var a=e.resolve(i);console.log("检索目录文件:",a);var o=[];try{r(a,function(t,e,i){var n={name:t,path:e,size:i.size,atimeMs:i.atimeMs,ctimeMs:i.ctimeMs,mtimeMs:i.mtimeMs};o.push(n)})}catch(t){console.error("检索文件错误:",t.message)}function r(e,i){console.log("检索目录:",e),t.readdir(e,function(t,n){if(t)console.warn("readdir:",t);else for(var s in n){var a=n[s];/^\.(\S+)?$/.test(a)||c(e,a,i)}})}function c(i,a,o){var c=e.join(i,a);t.stat(c,function(t,e){if(t)console.warn("stat",t);else{var p=!1;/^.*\.app$/.test(a)&&(p=!0);var u=e.isFile(),l=e.isDirectory();if(u||p)if(s){new RegExp(s).test(a)}else if(n){new RegExp(n).test(a)&&o(a,i,e)}else o(a,i,e);if(l){console.log("递归获取文件:",c);try{setTimeout(()=>{r(c,o)},2e3)}catch(t){console.warn("子目录异常:",t.message)}}}})}}};module.exports=i;